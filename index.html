<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ğŸ§§ æ–°å¹´å¿«æ¨‚</title>
<meta property="og:title" content="ğŸ§§ æ–°å¹´é©šå–œç­‰ä½ ä¾†æ‹†ï¼">
<meta property="og:description" content="æœ‰äººé€äº†ä½ ä¸€ä»½æ–°å¹´ç¦®ç‰©ï¼Œå¿«ä¾†æ‹†é–‹çœ‹çœ‹ï¼">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700;900&family=ZCOOL+KuaiLe&display=swap');
  body { font-family: 'Noto Serif TC', serif; background: #1a0a0a; color: #ffd700; overflow-x: hidden; min-height: 100vh; min-height: 100dvh; }
  .bg-pattern { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(circle at 20% 50%, rgba(200,0,0,0.3) 0%, transparent 50%), radial-gradient(circle at 80% 50%, rgba(200,0,0,0.2) 0%, transparent 50%), radial-gradient(circle at 50% 0%, rgba(255,215,0,0.1) 0%, transparent 40%); pointer-events: none; z-index: 0; }
  .lantern { position: fixed; font-size: 40px; opacity: 0.15; animation: floatLantern 8s ease-in-out infinite; pointer-events: none; z-index: 0; }
  .lantern:nth-child(2) { top: 10%; left: 5%; }
  .lantern:nth-child(3) { top: 30%; right: 8%; animation-delay: 2s; font-size: 30px; }
  .lantern:nth-child(4) { bottom: 20%; left: 10%; animation-delay: 4s; font-size: 35px; }
  .lantern:nth-child(5) { top: 60%; right: 5%; animation-delay: 1s; font-size: 25px; }
  @keyframes floatLantern { 0%,100% { transform: translateY(0) rotate(-5deg); } 50% { transform: translateY(-20px) rotate(5deg); } }
  .screen { display: none; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; min-height: 100dvh; padding: 20px; position: relative; z-index: 1; }
  .screen.active { display: flex; }

  /* CREATOR */
  .creator-card { background: rgba(40,10,10,0.9); border: 2px solid #ffd700; border-radius: 20px; padding: 30px 25px; width: min(90vw,420px); box-shadow: 0 0 40px rgba(255,215,0,0.15); }
  .creator-title { font-family: 'ZCOOL KuaiLe','Noto Serif TC',serif; font-size: clamp(1.4rem,5vw,2rem); color: #ffd700; text-align: center; margin-bottom: 5px; text-shadow: 0 0 15px rgba(255,215,0,0.4); }
  .creator-subtitle { font-size: 0.85rem; color: #cc9999; text-align: center; margin-bottom: 25px; }
  .form-group { margin-bottom: 18px; }
  .form-label { display: block; font-size: 0.9rem; color: #ffcc88; margin-bottom: 6px; }
  .form-input { width: 100%; padding: 12px 14px; background: rgba(0,0,0,0.4); border: 1.5px solid rgba(255,215,0,0.3); border-radius: 10px; color: #ffd700; font-family: 'Noto Serif TC',serif; font-size: 1rem; outline: none; transition: border-color 0.3s; }
  .form-input:focus { border-color: #ffd700; }
  .form-input::placeholder { color: rgba(255,215,0,0.3); }
  .form-file-label { display: flex; align-items: center; justify-content: center; width: 100%; padding: 30px 14px; background: rgba(0,0,0,0.4); border: 2px dashed rgba(255,215,0,0.3); border-radius: 12px; color: rgba(255,215,0,0.6); font-size: 0.95rem; cursor: pointer; transition: all 0.3s; text-align: center; flex-direction: column; gap: 8px; }
  .form-file-label:hover { border-color: #ffd700; color: #ffd700; }
  .form-file-label.has-file { border-color: #44cc44; color: #44cc44; border-style: solid; padding: 15px; }
  .form-file-label .upload-icon { font-size: 2rem; }
  .photo-preview { max-width: 100%; max-height: 150px; border-radius: 8px; margin-top: 8px; display: none; object-fit: cover; }
  .form-file-input { display: none; }
  .form-select { width: 100%; padding: 12px 14px; background: rgba(0,0,0,0.4); border: 1.5px solid rgba(255,215,0,0.3); border-radius: 10px; color: #ffd700; font-family: 'Noto Serif TC',serif; font-size: 1rem; outline: none; }
  .form-select option { background: #1a0a0a; color: #ffd700; }
  .btn-generate { width: 100%; padding: 14px; background: linear-gradient(135deg,#cc0000,#aa0000); color: #ffd700; border: 2px solid #ffd700; border-radius: 30px; font-family: 'ZCOOL KuaiLe','Noto Serif TC',serif; font-size: 1.15rem; cursor: pointer; transition: all 0.3s; margin-top: 10px; }
  .btn-generate:hover { transform: scale(1.02); }
  .btn-generate:active { transform: scale(0.98); }
  .link-result { display: none; margin-top: 20px; padding: 18px; background: rgba(0,80,0,0.2); border: 1.5px solid #44cc44; border-radius: 12px; text-align: center; }
  .link-result-title { color: #44cc44; font-size: 0.95rem; margin-bottom: 10px; }
  .link-display { word-break: break-all; font-size: 0.7rem; color: #aaddaa; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 6px; max-height: 80px; overflow-y: auto; margin-bottom: 12px; line-height: 1.4; }
  .btn-copy-link { padding: 10px 30px; background: #44cc44; color: #000; border: none; border-radius: 20px; font-family: 'Noto Serif TC',serif; font-size: 0.95rem; font-weight: 700; cursor: pointer; }
  .btn-preview { padding: 10px 30px; background: transparent; color: #ffd700; border: 1.5px solid #ffd700; border-radius: 20px; font-family: 'Noto Serif TC',serif; font-size: 0.95rem; cursor: pointer; margin-left: 8px; }
  .link-warning { font-size: 0.75rem; color: #cc8888; margin-top: 10px; }

  /* INTRO */
  .intro-title { font-family: 'ZCOOL KuaiLe','Noto Serif TC',serif; font-size: clamp(2rem,8vw,4rem); color: #ffd700; text-shadow: 0 0 20px rgba(255,215,0,0.5); text-align: center; margin-bottom: 10px; animation: titleGlow 2s ease-in-out infinite alternate; }
  @keyframes titleGlow { from { text-shadow: 0 0 20px rgba(255,215,0,0.5); } to { text-shadow: 0 0 40px rgba(255,215,0,0.8), 0 0 80px rgba(255,215,0,0.3); } }
  .intro-subtitle { font-size: clamp(0.9rem,3vw,1.2rem); color: #ffaaaa; margin-bottom: 40px; text-align: center; opacity: 0.8; }
  .intro-envelope { font-size: 100px; animation: bounce 2s ease-in-out infinite; cursor: pointer; filter: drop-shadow(0 10px 30px rgba(255,0,0,0.3)); transition: transform 0.3s; }
  .intro-envelope:hover { transform: scale(1.1); }
  .intro-envelope:active { transform: scale(0.95); }
  @keyframes bounce { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
  .intro-hint { margin-top: 30px; font-size: 0.9rem; color: #cc8888; animation: fadeInOut 2s ease-in-out infinite; }
  @keyframes fadeInOut { 0%,100% { opacity: 0.4; } 50% { opacity: 1; } }

  /* PUZZLE */
  #puzzle-screen { padding: 15px; }
  .puzzle-header { font-family: 'ZCOOL KuaiLe','Noto Serif TC',serif; font-size: clamp(1.2rem,5vw,1.8rem); color: #ffd700; margin-bottom: 10px; text-align: center; }
  .puzzle-container { position: relative; width: min(85vw,400px); height: min(85vw,400px); margin: 0 auto; border: 3px solid #ffd700; border-radius: 8px; overflow: hidden; box-shadow: 0 0 30px rgba(255,215,0,0.2); background: #111; }
  .puzzle-piece { position: absolute; cursor: grab; border: 1px solid rgba(255,215,0,0.15); z-index: 1; }
  .puzzle-piece:active { cursor: grabbing; z-index: 10; box-shadow: 0 0 20px rgba(255,215,0,0.5); }
  .puzzle-piece.correct { border-color: rgba(0,255,0,0.3); pointer-events: none; }
  .puzzle-ref { width: min(22vw,90px); height: min(22vw,90px); position: absolute; top: 8px; right: 8px; border: 2px solid #ffd700; border-radius: 6px; opacity: 0.7; z-index: 20; object-fit: cover; }
  .puzzle-progress { margin-top: 12px; font-size: 0.85rem; color: #ffaaaa; }
  .puzzle-progress-bar { width: min(85vw,400px); height: 6px; background: #333; border-radius: 3px; margin-top: 6px; overflow: hidden; }
  .puzzle-progress-fill { height: 100%; background: linear-gradient(90deg,#ff4444,#ffd700); border-radius: 3px; transition: width 0.3s; width: 0%; }
  .btn-shuffle { margin-top: 15px; padding: 10px 30px; background: linear-gradient(135deg,#cc0000,#aa0000); color: #ffd700; border: 2px solid #ffd700; border-radius: 30px; font-family: 'Noto Serif TC',serif; font-size: 1rem; cursor: pointer; }

  /* SCRATCH */
  .congrats-text { font-family: 'ZCOOL KuaiLe','Noto Serif TC',serif; font-size: clamp(1.5rem,7vw,2.5rem); color: #ffd700; text-shadow: 0 0 30px rgba(255,215,0,0.6); text-align: center; margin-bottom: 8px; animation: titleGlow 2s ease-in-out infinite alternate; }
  .congrats-sub { font-size: clamp(0.9rem,3vw,1.1rem); color: #ffaaaa; margin-bottom: 25px; text-align: center; }
  .scratch-wrapper { position: relative; width: min(80vw,320px); height: min(50vw,200px); border-radius: 16px; overflow: hidden; box-shadow: 0 8px 40px rgba(255,0,0,0.3); border: 3px solid #ffd700; }
  .scratch-bg { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg,#fff5e6,#fff0d0); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
  .prize-icon { font-size: 50px; margin-bottom: 8px; }
  .prize-text { font-family: 'ZCOOL KuaiLe','Noto Serif TC',serif; font-size: clamp(1rem,4vw,1.4rem); color: #cc0000; text-align: center; font-weight: 900; }
  .scratch-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: pointer; touch-action: none; }
  .scratch-hint { margin-top: 20px; font-size: 0.9rem; color: #ffaaaa; animation: fadeInOut 2s ease-in-out infinite; }

  /* PRIZE */
  .prize-reveal { text-align: center; animation: prizeAppear 0.8s ease-out; }
  @keyframes prizeAppear { from { opacity: 0; transform: scale(0.5) translateY(30px); } to { opacity: 1; transform: scale(1) translateY(0); } }
  .prize-big-icon { font-size: 80px; animation: bounce 1.5s ease-in-out infinite; }
  .prize-title { font-family: 'ZCOOL KuaiLe','Noto Serif TC',serif; font-size: clamp(1.8rem,8vw,3rem); color: #ffd700; text-shadow: 0 0 30px rgba(255,215,0,0.6); margin: 15px 0 8px; }
  .prize-desc { font-size: clamp(0.9rem,3vw,1.1rem); color: #ffcccc; margin-bottom: 25px; }
  .btn-claim { padding: 16px 50px; background: linear-gradient(135deg,#ff1a1a,#cc0000); color: #ffd700; border: 3px solid #ffd700; border-radius: 40px; font-family: 'ZCOOL KuaiLe','Noto Serif TC',serif; font-size: clamp(1.2rem,4vw,1.5rem); cursor: pointer; box-shadow: 0 4px 20px rgba(255,0,0,0.4); animation: pulseBtn 2s ease-in-out infinite; position: relative; overflow: hidden; }
  .btn-claim:active { transform: scale(0.98); }
  @keyframes pulseBtn { 0%,100% { box-shadow: 0 4px 20px rgba(255,0,0,0.4); } 50% { box-shadow: 0 4px 30px rgba(255,0,0,0.6), 0 0 60px rgba(255,215,0,0.4); } }
  .btn-claim::after { content: ''; position: absolute; top: -50%; left: -60%; width: 40%; height: 200%; background: linear-gradient(90deg,transparent,rgba(255,255,255,0.2),transparent); animation: shimmer 2.5s infinite; }
  @keyframes shimmer { 0% { left: -60%; } 100% { left: 120%; } }
  .manual-code { margin-top: 20px; font-size: 0.8rem; color: #aa8888; text-align: center; }
  .manual-code span { display: inline-block; background: rgba(255,215,0,0.1); padding: 4px 12px; border-radius: 4px; font-family: monospace; color: #ffd700; margin-top: 4px; letter-spacing: 1px; user-select: all; }
  .btn-make-own { margin-top: 35px; padding: 10px 24px; background: transparent; color: #aa8888; border: 1px solid #aa8888; border-radius: 20px; font-family: 'Noto Serif TC',serif; font-size: 0.8rem; cursor: pointer; }
  .btn-make-own:hover { color: #ffd700; border-color: #ffd700; }

  /* EFFECTS */
  .coin-container { position: fixed; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 100; overflow: hidden; }
  .coin { position: absolute; top: -50px; animation: coinFall linear forwards; pointer-events: none; }
  @keyframes coinFall { 0% { transform: translateY(0) rotate(0deg); opacity: 1; } 80% { opacity: 1; } 100% { transform: translateY(110vh) rotate(720deg); opacity: 0; } }
  .firework { position: fixed; pointer-events: none; z-index: 99; }
  .firework-particle { position: absolute; width: 4px; height: 4px; border-radius: 50%; animation: fireworkBurst 1s ease-out forwards; }
  @keyframes fireworkBurst { 0% { transform: translate(0,0) scale(1); opacity: 1; } 100% { transform: translate(var(--tx),var(--ty)) scale(0); opacity: 0; } }
  .copied-toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%) scale(0); background: rgba(0,0,0,0.93); color: #ffd700; padding: 24px 40px; border-radius: 16px; font-size: 1.2rem; border: 2px solid #ffd700; z-index: 9999; transition: transform 0.3s; text-align: center; }
  .copied-toast.show { transform: translate(-50%,-50%) scale(1); }
  .loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 9999; color: #ffd700; font-size: 1.1rem; flex-direction: column; gap: 15px; }
  .loading-overlay.show { display: flex; }
  .loading-spinner { width: 40px; height: 40px; border: 3px solid rgba(255,215,0,0.2); border-top-color: #ffd700; border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  @media (max-width: 380px) { .puzzle-container { width: 90vw; height: 90vw; } .scratch-wrapper { width: 88vw; height: 55vw; } .creator-card { padding: 20px 16px; } }
</style>
</head>
<body>
<div class="bg-pattern"></div>
<div class="lantern">ğŸ®</div><div class="lantern">ğŸ®</div><div class="lantern">ğŸ®</div><div class="lantern">ğŸ®</div>

<!-- CREATOR -->
<div id="creator-screen" class="screen">
  <div class="creator-card">
    <div class="creator-title">âœ¨ è£½ä½œæ–°å¹´é©šå–œ</div>
    <div class="creator-subtitle">ä¸‰æ­¥é©Ÿåšå¥½ï¼Œå‚³é€£çµçµ¦æœ‹å‹å°±èƒ½ç©</div>
    <div class="form-group">
      <label class="form-label">ğŸ“¸ ä¸Šå‚³æ‹¼åœ–ç…§ç‰‡</label>
      <label class="form-file-label" id="file-label"><span class="upload-icon">ğŸ“·</span><span id="file-label-text">é»é€™è£¡é¸æ“‡ç…§ç‰‡</span></label>
      <input type="file" accept="image/*" class="form-file-input" id="photo-input">
      <img class="photo-preview" id="photo-preview">
    </div>
    <div class="form-group"><label class="form-label">ğŸ”‘ ç¦®ç‰©å¡åºè™Ÿ</label><input type="text" class="form-input" id="code-input" placeholder="ä¾‹ï¼šUBER-EAT-1234-5678"></div>
    <div class="form-group"><label class="form-label">ğŸ’¬ ç¥ç¦èª</label><input type="text" class="form-input" id="greeting-input" placeholder="æ­å–œç™¼è²¡ï¼Œå¤§å‰å¤§åˆ©" value="æ­å–œç™¼è²¡ï¼Œå¤§å‰å¤§åˆ©"></div>
    <div class="form-group"><label class="form-label">ğŸ ç¦®ç‰©é¡å‹</label>
      <select class="form-select" id="gift-type-select">
        <option value="ubereats">ğŸ” Uber Eats ç¦®ç‰©å¡</option>
        <option value="starbucks">â˜• æ˜Ÿå·´å…‹ç¦®ç‰©å¡</option>
        <option value="foodpanda">ğŸ¼ foodpanda ç¦®ç‰©å¡</option>
        <option value="momo">ğŸ›’ momo è³¼ç‰©é‡‘</option>
        <option value="custom">ğŸ å…¶ä»–ç¦®ç‰©</option>
      </select>
    </div>
    <div class="form-group"><label class="form-label">ğŸ§© æ‹¼åœ–é›£åº¦</label>
      <select class="form-select" id="difficulty-select">
        <option value="4" selected>ç°¡å–®ï¼ˆ4Ã—4ï¼‰</option><option value="5">ä¸­ç­‰ï¼ˆ5Ã—5ï¼‰</option><option value="6">å›°é›£ï¼ˆ6Ã—6ï¼‰</option>
      </select>
    </div>
    <button class="btn-generate" id="btn-generate">ğŸ§§ ç”¢ç”Ÿé€£çµ</button>
    <div class="link-result" id="link-result">
      <div class="link-result-title">âœ… é€£çµç”¢ç”ŸæˆåŠŸï¼å‚³çµ¦å°æ–¹å°±èƒ½ç©</div>
      <div class="link-display" id="link-display"></div>
      <div><button class="btn-copy-link" id="btn-copy-link">ğŸ“‹ è¤‡è£½é€£çµ</button><button class="btn-preview" id="btn-preview">ğŸ‘€ é è¦½</button></div>
      <div class="link-warning">âš ï¸ é€£çµåŒ…å«ç…§ç‰‡è³‡æ–™ï¼Œè‹¥å¤ªé•·å¯è©¦è¼ƒå°çš„ç…§ç‰‡</div>
    </div>
  </div>
</div>

<!-- INTRO -->
<div id="intro-screen" class="screen">
  <div class="intro-title">ğŸ§§ æ–°å¹´å¿«æ¨‚ ğŸ§§</div>
  <div class="intro-subtitle" id="greeting-text"></div>
  <div class="intro-envelope" id="start-btn" role="button">ğŸ§§</div>
  <div class="intro-hint">ğŸ‘† é»æ“Šç´…åŒ…é–‹å§‹</div>
</div>

<!-- PUZZLE -->
<div id="puzzle-screen" class="screen">
  <div class="puzzle-header">ğŸ§© æ‹¼å‡ºæ–°å¹´å¥½é‹</div>
  <div class="puzzle-container" id="puzzle-container"><img class="puzzle-ref" id="puzzle-ref" alt="åƒè€ƒåœ–"></div>
  <div class="puzzle-progress">å·²å®Œæˆ <span id="progress-count">0</span> / <span id="progress-total">16</span> ç‰‡</div>
  <div class="puzzle-progress-bar"><div class="puzzle-progress-fill" id="progress-fill"></div></div>
  <button class="btn-shuffle" id="btn-shuffle">ğŸ”€ é‡æ–°æ‰“äº‚</button>
</div>

<!-- SCRATCH -->
<div id="scratch-screen" class="screen">
  <div class="congrats-text">ğŸ‰ æ­å–œå®Œæˆï¼</div>
  <div class="congrats-sub">æ–°å¹´å¿«æ¨‚ï¼Œç¥æ‚¨ä¸­å¤§çï¼</div>
  <div class="scratch-wrapper" id="scratch-wrapper">
    <div class="scratch-bg"><div class="prize-icon" id="prize-emoji">ğŸ”</div><div class="prize-text" id="prize-label">æ­å–œç²å¾—<br>Uber Eats ç¾é£Ÿç¦®ç‰©å¡ï¼</div></div>
    <canvas class="scratch-canvas" id="scratch-canvas"></canvas>
  </div>
  <div class="scratch-hint">ğŸ‘† ç”¨æ‰‹æŒ‡åˆ®é–‹çœ‹çœ‹</div>
</div>

<!-- PRIZE -->
<div id="prize-screen" class="screen">
  <div class="prize-reveal">
    <div class="prize-big-icon">ğŸŠ</div>
    <div class="prize-title">æ­å–œä¸­çï¼</div>
    <div class="prize-desc">ğŸ§§ æ­å–œç™¼è²¡ï¼ç´…åŒ…æ‹¿ä¾†ï¼</div>
    <button class="btn-claim" id="btn-claim">ğŸ” é ˜å–ç¦®ç‰©å¡</button>
    <div class="manual-code">å¦‚æœæ²’æœ‰è‡ªå‹•è·³è½‰ï¼Œè«‹æ‰‹å‹•è¤‡è£½åºè™Ÿï¼š<br><span id="manual-code-display"></span></div>
    <button class="btn-make-own" id="btn-make-own">âœ¨ æˆ‘ä¹Ÿè¦åšä¸€å€‹é€æœ‹å‹</button>
  </div>
</div>

<div class="copied-toast" id="copied-toast"></div>
<div class="coin-container" id="coin-container"></div>
<div class="loading-overlay" id="loading-overlay"><div class="loading-spinner"></div><div>æ­£åœ¨ç”¢ç”Ÿé€£çµ...</div></div>

<script>
// â˜…â˜…â˜… æŠŠä½ çš„ ImgBB API Key è²¼åœ¨é€™è£¡ â˜…â˜…â˜…
const IMGBB_API_KEY = 'f3b38ce5bec9cb00a5ee4c5bf768ad2a';

const GIFT_TYPES={ubereats:{emoji:'ğŸ”',label:'æ­å–œç²å¾—<br>Uber Eats ç¾é£Ÿç¦®ç‰©å¡ï¼',btn:'ğŸ” é ˜å– Uber Eats ç¦®ç‰©å¡',url:'https://www.ubereats.com'},starbucks:{emoji:'â˜•',label:'æ­å–œç²å¾—<br>æ˜Ÿå·´å…‹ç¦®ç‰©å¡ï¼',btn:'â˜• é ˜å–æ˜Ÿå·´å…‹ç¦®ç‰©å¡',url:'https://www.starbucks.com.tw'},foodpanda:{emoji:'ğŸ¼',label:'æ­å–œç²å¾—<br>foodpanda ç¾é£Ÿç¦®ç‰©å¡ï¼',btn:'ğŸ¼ é ˜å– foodpanda ç¦®ç‰©å¡',url:'https://www.foodpanda.com.tw'},momo:{emoji:'ğŸ›’',label:'æ­å–œç²å¾—<br>momo è³¼ç‰©é‡‘ï¼',btn:'ğŸ›’ é ˜å– momo è³¼ç‰©é‡‘',url:'https://www.momoshop.com.tw'},custom:{emoji:'ğŸ',label:'æ­å–œç²å¾—<br>ç¥ç§˜ç¦®ç‰©ï¼',btn:'ğŸ é ˜å–ç¦®ç‰©',url:''}};

let CONFIG={puzzleImage:'',giftCode:'',greeting:'æ­å–œç™¼è²¡ï¼Œå¤§å‰å¤§åˆ©',giftType:'ubereats',puzzleSize:4,scratchThreshold:0.45,prizeDelay:2000};

// AUDIO
let audioCtx=null;
function ac(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();return audioCtx;}
function playCoinSound(){try{const c=ac(),o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(c.destination);o.type='triangle';o.frequency.setValueAtTime(1200,c.currentTime);o.frequency.exponentialRampToValueAtTime(2400,c.currentTime+0.1);g.gain.setValueAtTime(0.3,c.currentTime);g.gain.exponentialRampToValueAtTime(0.01,c.currentTime+0.3);o.start(c.currentTime);o.stop(c.currentTime+0.3);}catch(e){}}
function playWinSound(){try{const c=ac();[523,659,784,1047].forEach((f,i)=>{const o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(c.destination);o.type='triangle';o.frequency.value=f;g.gain.setValueAtTime(0.25,c.currentTime+i*0.15);g.gain.exponentialRampToValueAtTime(0.01,c.currentTime+i*0.15+0.5);o.start(c.currentTime+i*0.15);o.stop(c.currentTime+i*0.15+0.5);});}catch(e){}}
function playJackpotSound(){try{const c=ac();[523,587,659,784,880,1047,1175,1319].forEach((f,i)=>{const o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(c.destination);o.type='square';o.frequency.value=f;g.gain.setValueAtTime(0.15,c.currentTime+i*0.1);g.gain.exponentialRampToValueAtTime(0.01,c.currentTime+i*0.1+0.4);o.start(c.currentTime+i*0.1);o.stop(c.currentTime+i*0.1+0.4);});[1047,1319,1568].forEach(f=>{const o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(c.destination);o.type='triangle';o.frequency.value=f;const t=c.currentTime+0.85;g.gain.setValueAtTime(0.2,t);g.gain.exponentialRampToValueAtTime(0.01,t+1.5);o.start(t);o.stop(t+1.5);});}catch(e){}}
function playScratchSound(){try{const c=ac(),b=c.createBuffer(1,c.sampleRate*0.05,c.sampleRate),d=b.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=Math.random()*2-1;const s=c.createBufferSource();s.buffer=b;const g=c.createGain();g.gain.value=0.05;const fl=c.createBiquadFilter();fl.type='bandpass';fl.frequency.value=3000;s.connect(fl);fl.connect(g);g.connect(c.destination);s.start();}catch(e){}}

// EFFECTS
function spawnCoins(n=30,dur=3000){const co=document.getElementById('coin-container'),em=['ğŸª™','ğŸ’°','ğŸ§§','âœ¨','ğŸŠ','ğŸ’µ'];for(let i=0;i<n;i++){setTimeout(()=>{const c=document.createElement('div');c.className='coin';c.textContent=em[Math.floor(Math.random()*em.length)];c.style.left=Math.random()*100+'vw';c.style.fontSize=(20+Math.random()*25)+'px';const d=2+Math.random()*2;c.style.animationDuration=d+'s';co.appendChild(c);setTimeout(()=>c.remove(),d*1000);},Math.random()*dur);}}
function spawnFirework(x,y){const cl=['#ffd700','#ff4444','#ff8800','#ffaaaa','#fff'],el=document.createElement('div');el.className='firework';el.style.left=x+'px';el.style.top=y+'px';document.body.appendChild(el);for(let i=0;i<20;i++){const p=document.createElement('div');p.className='firework-particle';const a=Math.PI*2*i/20,d=50+Math.random()*80;p.style.setProperty('--tx',Math.cos(a)*d+'px');p.style.setProperty('--ty',Math.sin(a)*d+'px');p.style.background=cl[Math.floor(Math.random()*cl.length)];el.appendChild(p);}setTimeout(()=>el.remove(),1200);}
function fireMultipleFireworks(){for(let i=0;i<6;i++)setTimeout(()=>spawnFirework(Math.random()*innerWidth,Math.random()*innerHeight*0.6),i*350);}

function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');}
function showToast(msg){const t=document.getElementById('copied-toast');t.innerHTML=msg.replace(/\n/g,'<br>');t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500);}

// IMAGE COMPRESS (for faster upload)
function compressImage(file,maxW=600,q=0.7){return new Promise(r=>{const rd=new FileReader();rd.onload=e=>{const img=new Image();img.onload=()=>{const cv=document.createElement('canvas');let w=img.width,h=img.height;if(w>h){if(w>maxW){h=maxW/w*h;w=maxW;}}else{if(h>maxW){w=maxW/h*w;h=maxW;}}cv.width=w;cv.height=h;cv.getContext('2d').drawImage(img,0,0,w,h);cv.toBlob(blob=>r(blob),'image/jpeg',q);};img.src=e.target.result;};rd.readAsDataURL(file);});}

// IMGBB UPLOAD (7 days = 604800 seconds)
async function uploadToImgBB(blob){
  return new Promise((resolve,reject)=>{
    const reader=new FileReader();
    reader.onload=async function(){
      try{
        const base64=reader.result.split(',')[1];
        const url='https://api.imgbb.com/1/upload?key='+IMGBB_API_KEY+'&expiration=604800';
        
        // Method 1: FormData with base64
        const fd=new FormData();
        fd.append('image',base64);
        
        const res=await fetch(url,{
          method:'POST',
          body:fd
        });
        
        if(!res.ok){
          reject(new Error('HTTPéŒ¯èª¤ '+res.status));
          return;
        }
        
        const data=await res.json();
        
        if(!data.success){
          reject(new Error(JSON.stringify(data.error||data)));
          return;
        }
        
        resolve(data.data.display_url);
      }catch(e){
        reject(new Error('ç¶²è·¯éŒ¯èª¤: '+e.message));
      }
    };
    reader.onerror=()=>reject(new Error('è®€å–æª”æ¡ˆå¤±æ•—'));
    reader.readAsDataURL(blob);
  });
}

// URL ENCODE/DECODE (short params only, no image data)
function buildUrl(imageUrl,code,greeting,type,size){
  const params=new URLSearchParams();
  params.set('p',imageUrl);
  params.set('c',code);
  params.set('g',greeting);
  params.set('t',type);
  params.set('s',size);
  return location.origin+location.pathname+'?'+params.toString();
}

function readUrlParams(){
  const params=new URLSearchParams(location.search);
  if(!params.get('p'))return null;
  return{
    puzzleImage:params.get('p'),
    giftCode:params.get('c')||'',
    greeting:params.get('g')||'æ­å–œç™¼è²¡ï¼Œå¤§å‰å¤§åˆ©',
    giftType:params.get('t')||'ubereats',
    puzzleSize:parseInt(params.get('s'))||4
  };
}

// CREATOR
let selectedFile=null;
document.getElementById('file-label').addEventListener('click',()=>document.getElementById('photo-input').click());
document.getElementById('photo-input').addEventListener('change',async e=>{const f=e.target.files[0];if(!f)return;selectedFile=f;document.getElementById('file-label').classList.add('has-file');document.getElementById('file-label-text').textContent='âœ… '+f.name;const rd=new FileReader();rd.onload=ev=>{const p=document.getElementById('photo-preview');p.src=ev.target.result;p.style.display='block';};rd.readAsDataURL(f);});

document.getElementById('btn-generate').addEventListener('click',async()=>{
  if(!selectedFile){showToast('âš ï¸ è«‹å…ˆä¸Šå‚³ç…§ç‰‡');return;}
  const code=document.getElementById('code-input').value.trim();
  if(!code){showToast('âš ï¸ è«‹è¼¸å…¥ç¦®ç‰©å¡åºè™Ÿ');return;}
  const greeting=document.getElementById('greeting-input').value.trim()||'æ­å–œç™¼è²¡ï¼Œå¤§å‰å¤§åˆ©';
  const type=document.getElementById('gift-type-select').value;
  const size=parseInt(document.getElementById('difficulty-select').value);
  
  document.getElementById('loading-overlay').classList.add('show');
  try{
    const blob=await compressImage(selectedFile);
    const imageUrl=await uploadToImgBB(blob);
    const url=buildUrl(imageUrl,code,greeting,type,size);
    document.getElementById('link-display').textContent=url;
    document.getElementById('link-result').style.display='block';
    document.querySelector('.link-warning').textContent='ğŸ“¸ ç…§ç‰‡æœƒåœ¨ 7 å¤©å¾Œè‡ªå‹•åˆªé™¤ï¼Œè«‹ç¢ºä¿å°æ–¹åœ¨æœŸé™å…§æ‰“é–‹';
    document.querySelector('.link-warning').style.color='#ffcc88';
  }catch(err){
    showToast('âŒ '+err.message);
    console.error('Upload error:',err);
  }
  document.getElementById('loading-overlay').classList.remove('show');
});

document.getElementById('btn-copy-link').addEventListener('click',async()=>{const u=document.getElementById('link-display').textContent;try{await navigator.clipboard.writeText(u);}catch{const t=document.createElement('textarea');t.value=u;document.body.appendChild(t);t.select();document.execCommand('copy');document.body.removeChild(t);}showToast('âœ… é€£çµå·²è¤‡è£½ï¼\nå‚³çµ¦å°æ–¹å°±èƒ½ç©');});
document.getElementById('btn-preview').addEventListener('click',()=>window.open(document.getElementById('link-display').textContent,'_blank'));

// INIT
function init(){const d=readUrlParams();if(d){CONFIG={...CONFIG,...d};setupPlayer();return;}showScreen('creator-screen');}

function setupPlayer(){const g=GIFT_TYPES[CONFIG.giftType]||GIFT_TYPES.ubereats;document.getElementById('greeting-text').textContent=CONFIG.greeting;document.getElementById('puzzle-ref').src=CONFIG.puzzleImage;document.getElementById('progress-total').textContent=CONFIG.puzzleSize*CONFIG.puzzleSize;document.getElementById('prize-emoji').textContent=g.emoji;document.getElementById('prize-label').innerHTML=g.label;document.getElementById('btn-claim').textContent=g.btn;document.getElementById('manual-code-display').textContent=CONFIG.giftCode;showScreen('intro-screen');}

// INTRO
document.getElementById('start-btn').addEventListener('click',()=>{playCoinSound();showScreen('puzzle-screen');initPuzzle();});

// PUZZLE
let pieces=[],correctCount=0;
function initPuzzle(){const c=document.getElementById('puzzle-container'),sz=CONFIG.puzzleSize,cs=c.offsetWidth,pw=cs/sz,ph=cs/sz,tp=sz*sz;c.querySelectorAll('.puzzle-piece').forEach(p=>p.remove());pieces=[];correctCount=0;updateProgress(tp);
for(let r=0;r<sz;r++)for(let cl=0;cl<sz;cl++){const p=document.createElement('div');p.className='puzzle-piece';p.style.width=pw+'px';p.style.height=ph+'px';p.style.backgroundImage=`url('${CONFIG.puzzleImage}')`;p.style.backgroundPosition=`${-cl*pw}px ${-r*ph}px`;p.style.backgroundSize=`${cs}px ${cs}px`;p.dataset.correctX=cl*pw;p.dataset.correctY=r*ph;pieces.push(p);c.appendChild(p);}
shufflePieces(cs,pw,ph,sz);setupDrag(c,pw,ph,cs,tp);}

function shufflePieces(cs,pw,ph,sz){correctCount=0;pieces.forEach(p=>{p.classList.remove('correct');p.style.pointerEvents='';p.style.left=Math.floor(Math.random()*sz)*pw+'px';p.style.top=Math.floor(Math.random()*sz)*ph+'px';});updateProgress(sz*sz);}

function setupDrag(container,pw,ph,cs,tp){let dr=null,ox,oy;
function onS(e){const t=e.target.closest('.puzzle-piece');if(!t||t.classList.contains('correct'))return;dr=t;dr.style.zIndex=10;const r=container.getBoundingClientRect(),cx=e.touches?e.touches[0].clientX:e.clientX,cy=e.touches?e.touches[0].clientY:e.clientY;ox=cx-r.left-parseFloat(dr.style.left);oy=cy-r.top-parseFloat(dr.style.top);e.preventDefault();}
function onM(e){if(!dr)return;const r=container.getBoundingClientRect(),cx=e.touches?e.touches[0].clientX:e.clientX,cy=e.touches?e.touches[0].clientY:e.clientY;dr.style.left=Math.max(0,Math.min(cx-r.left-ox,cs-pw))+'px';dr.style.top=Math.max(0,Math.min(cy-r.top-oy,cs-ph))+'px';e.preventDefault();}
function onE(){if(!dr)return;const sx=Math.round(parseFloat(dr.style.left)/pw)*pw,sy=Math.round(parseFloat(dr.style.top)/ph)*ph;dr.style.left=sx+'px';dr.style.top=sy+'px';dr.style.zIndex=1;const cx=parseFloat(dr.dataset.correctX),cy=parseFloat(dr.dataset.correctY);if(Math.abs(sx-cx)<2&&Math.abs(sy-cy)<2){dr.classList.add('correct');dr.style.left=cx+'px';dr.style.top=cy+'px';playCoinSound();correctCount++;updateProgress(tp);if(correctCount>=tp)onPuzzleComplete();}dr=null;}
container.addEventListener('mousedown',onS);container.addEventListener('mousemove',onM);container.addEventListener('mouseup',onE);container.addEventListener('touchstart',onS,{passive:false});container.addEventListener('touchmove',onM,{passive:false});container.addEventListener('touchend',onE);}

function updateProgress(t){document.getElementById('progress-count').textContent=correctCount;document.getElementById('progress-fill').style.width=(correctCount/t*100)+'%';}
function onPuzzleComplete(){playWinSound();spawnCoins(15,1500);setTimeout(()=>{showScreen('scratch-screen');initScratchCard();},1500);}
document.getElementById('btn-shuffle').addEventListener('click',()=>{const c=document.getElementById('puzzle-container'),s=CONFIG.puzzleSize;shufflePieces(c.offsetWidth,c.offsetWidth/s,c.offsetWidth/s,s);});

// SCRATCH
let scratchRevealed=false;
function initScratchCard(){scratchRevealed=false;const w=document.getElementById('scratch-wrapper'),cv=document.getElementById('scratch-canvas'),ctx=cv.getContext('2d');cv.width=w.offsetWidth;cv.height=w.offsetHeight;cv.style.opacity='1';cv.style.transition='';
const gr=ctx.createLinearGradient(0,0,cv.width,cv.height);gr.addColorStop(0,'#cc0000');gr.addColorStop(0.5,'#ee2222');gr.addColorStop(1,'#cc0000');ctx.fillStyle=gr;ctx.fillRect(0,0,cv.width,cv.height);ctx.strokeStyle='#ffd700';ctx.lineWidth=3;ctx.strokeRect(10,10,cv.width-20,cv.height-20);ctx.strokeRect(15,15,cv.width-30,cv.height-30);ctx.fillStyle='#ffd700';ctx.font=`bold ${Math.min(cv.width*0.08,28)}px "Noto Serif TC",serif`;ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('ğŸ° åˆ®åˆ®æ¨‚ ğŸ°',cv.width/2,cv.height/2-15);ctx.font=`${Math.min(cv.width*0.05,18)}px "Noto Serif TC",serif`;ctx.fillText('ç”¨æ‰‹æŒ‡åˆ®é–‹æ­¤å€',cv.width/2,cv.height/2+20);
let isS=false,ls=0;
function scratch(x,y){ctx.globalCompositeOperation='destination-out';ctx.beginPath();ctx.arc(x,y,25,0,Math.PI*2);ctx.fill();if(Date.now()-ls>80){playScratchSound();ls=Date.now();}checkScratch();}
function gp(e){const r=cv.getBoundingClientRect(),cx=e.touches?e.touches[0].clientX:e.clientX,cy=e.touches?e.touches[0].clientY:e.clientY;return{x:(cx-r.left)*(cv.width/r.width),y:(cy-r.top)*(cv.height/r.height)};}
cv.onmousedown=e=>{isS=true;const p=gp(e);scratch(p.x,p.y);};cv.onmousemove=e=>{if(isS){const p=gp(e);scratch(p.x,p.y);}};cv.onmouseup=()=>isS=false;cv.onmouseleave=()=>isS=false;
cv.addEventListener('touchstart',e=>{isS=true;const p=gp(e);scratch(p.x,p.y);e.preventDefault();},{passive:false});cv.addEventListener('touchmove',e=>{if(isS){const p=gp(e);scratch(p.x,p.y);}e.preventDefault();},{passive:false});cv.addEventListener('touchend',()=>isS=false);}

function checkScratch(){if(scratchRevealed)return;const cv=document.getElementById('scratch-canvas'),d=cv.getContext('2d').getImageData(0,0,cv.width,cv.height).data;let t=0;for(let i=3;i<d.length;i+=4)if(d[i]===0)t++;if(t/(d.length/4)>=CONFIG.scratchThreshold){scratchRevealed=true;cv.style.transition='opacity 0.5s';cv.style.opacity='0';setTimeout(()=>{playJackpotSound();spawnCoins(50,3000);fireMultipleFireworks();showScreen('prize-screen');},CONFIG.prizeDelay);}}

// PRIZE
document.getElementById('btn-claim').addEventListener('click',async()=>{const code=CONFIG.giftCode;try{await navigator.clipboard.writeText(code);}catch{const t=document.createElement('textarea');t.value=code;document.body.appendChild(t);t.select();document.execCommand('copy');document.body.removeChild(t);}showToast('âœ… åºè™Ÿå·²è¤‡è£½ï¼\næ­£åœ¨è·³è½‰...');playCoinSound();spawnCoins(20,1500);const g=GIFT_TYPES[CONFIG.giftType]||GIFT_TYPES.ubereats;if(g.url)setTimeout(()=>{window.location.href=g.url;},1500);});

document.getElementById('btn-make-own').addEventListener('click',()=>{window.location.href=location.origin+location.pathname;});

init();
</script>
</body>
</html> 
