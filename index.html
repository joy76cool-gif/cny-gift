<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ğŸ§§ æ–°å¹´å¿«æ¨‚</title>
<meta property="og:title" content="ğŸ§§ æ–°å¹´é©šå–œç­‰ä½ ä¾†æ‹†ï¼">
<meta property="og:description" content="æœ‰äººé€äº†ä½ ä¸€ä»½æ–°å¹´ç¦®ç‰©ï¼Œå¿«ä¾†æ‹†é–‹çœ‹çœ‹ï¼">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
@import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700;900&family=ZCOOL+KuaiLe&display=swap');
body{font-family:'Noto Serif TC',serif;background:#1a0a0a;color:#ffd700;overflow-x:hidden;min-height:100vh;min-height:100dvh}
.bg-pattern{position:fixed;inset:0;background:radial-gradient(circle at 20% 50%,rgba(200,0,0,.3) 0%,transparent 50%),radial-gradient(circle at 80% 50%,rgba(200,0,0,.2) 0%,transparent 50%),radial-gradient(circle at 50% 0%,rgba(255,215,0,.1) 0%,transparent 40%);pointer-events:none;z-index:0}
.lantern{position:fixed;font-size:40px;opacity:.15;animation:fl 8s ease-in-out infinite;pointer-events:none;z-index:0}
.lantern:nth-child(2){top:10%;left:5%}.lantern:nth-child(3){top:30%;right:8%;animation-delay:2s;font-size:30px}.lantern:nth-child(4){bottom:20%;left:10%;animation-delay:4s;font-size:35px}.lantern:nth-child(5){top:60%;right:5%;animation-delay:1s;font-size:25px}
@keyframes fl{0%,100%{transform:translateY(0) rotate(-5deg)}50%{transform:translateY(-20px) rotate(5deg)}}
.screen{display:none;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;min-height:100dvh;padding:20px;position:relative;z-index:1}.screen.active{display:flex}

/* CREATOR */
.creator-card{background:rgba(40,10,10,.9);border:2px solid #ffd700;border-radius:20px;padding:30px 25px;width:min(90vw,420px);box-shadow:0 0 40px rgba(255,215,0,.15)}
.creator-title{font-family:'ZCOOL KuaiLe',serif;font-size:clamp(1.4rem,5vw,2rem);text-align:center;margin-bottom:5px;text-shadow:0 0 15px rgba(255,215,0,.4)}
.creator-subtitle{font-size:.85rem;color:#cc9999;text-align:center;margin-bottom:25px}
.form-group{margin-bottom:18px}.form-label{display:block;font-size:.9rem;color:#ffcc88;margin-bottom:6px}
.form-input{width:100%;padding:12px 14px;background:rgba(0,0,0,.4);border:1.5px solid rgba(255,215,0,.3);border-radius:10px;color:#ffd700;font-family:'Noto Serif TC',serif;font-size:1rem;outline:none}.form-input:focus{border-color:#ffd700}.form-input::placeholder{color:rgba(255,215,0,.3)}
.form-file-label{display:flex;align-items:center;justify-content:center;width:100%;padding:30px 14px;background:rgba(0,0,0,.4);border:2px dashed rgba(255,215,0,.3);border-radius:12px;color:rgba(255,215,0,.6);font-size:.95rem;cursor:pointer;text-align:center;flex-direction:column;gap:8px}.form-file-label:hover{border-color:#ffd700;color:#ffd700}.form-file-label.has-file{border-color:#44cc44;color:#44cc44;border-style:solid;padding:15px}
.upload-icon{font-size:2rem}.photo-preview{max-width:100%;max-height:150px;border-radius:8px;margin-top:8px;display:none;object-fit:cover}.form-file-input{display:none}
.form-select{width:100%;padding:12px 14px;background:rgba(0,0,0,.4);border:1.5px solid rgba(255,215,0,.3);border-radius:10px;color:#ffd700;font-family:'Noto Serif TC',serif;font-size:1rem;outline:none}.form-select option{background:#1a0a0a;color:#ffd700}
.btn-generate{width:100%;padding:14px;background:linear-gradient(135deg,#cc0000,#aa0000);color:#ffd700;border:2px solid #ffd700;border-radius:30px;font-family:'ZCOOL KuaiLe',serif;font-size:1.15rem;cursor:pointer;margin-top:10px}
.link-result{display:none;margin-top:20px;padding:18px;background:rgba(0,80,0,.2);border:1.5px solid #44cc44;border-radius:12px;text-align:center}.link-result-title{color:#44cc44;font-size:.95rem;margin-bottom:10px}
.link-display{word-break:break-all;font-size:.7rem;color:#aaddaa;background:rgba(0,0,0,.3);padding:10px;border-radius:6px;max-height:80px;overflow-y:auto;margin-bottom:12px}
.btn-copy-link{padding:10px 30px;background:#44cc44;color:#000;border:none;border-radius:20px;font-family:'Noto Serif TC',serif;font-size:.95rem;font-weight:700;cursor:pointer}
.btn-preview{padding:10px 30px;background:transparent;color:#ffd700;border:1.5px solid #ffd700;border-radius:20px;font-family:'Noto Serif TC',serif;font-size:.95rem;cursor:pointer;margin-left:8px}
.link-warning{font-size:.75rem;color:#cc8888;margin-top:10px}

/* INTRO */
.intro-title{font-family:'ZCOOL KuaiLe',serif;font-size:clamp(2rem,8vw,4rem);text-shadow:0 0 20px rgba(255,215,0,.5);text-align:center;margin-bottom:10px;animation:glow 2s ease-in-out infinite alternate;white-space:nowrap}
@keyframes glow{from{text-shadow:0 0 20px rgba(255,215,0,.5)}to{text-shadow:0 0 40px rgba(255,215,0,.8),0 0 80px rgba(255,215,0,.3)}}
.intro-subtitle{font-size:clamp(.9rem,3vw,1.2rem);color:#ffaaaa;margin-bottom:40px;text-align:center;opacity:.8;white-space:nowrap}
.intro-envelope{font-size:100px;animation:bounce 2s ease-in-out infinite;cursor:pointer;filter:drop-shadow(0 10px 30px rgba(255,0,0,.3))}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-15px)}}
.intro-hint{margin-top:30px;font-size:.9rem;color:#cc8888;animation:fade 2s ease-in-out infinite;white-space:nowrap}
@keyframes fade{0%,100%{opacity:.4}50%{opacity:1}}

/* PUZZLE */
#puzzle-screen{padding:10px 15px}
.puzzle-header{font-family:'ZCOOL KuaiLe',serif;font-size:clamp(1.2rem,5vw,1.8rem);margin-bottom:8px;text-align:center;white-space:nowrap}
.puzzle-wrapper{position:relative;margin:0 auto;display:flex;flex-direction:column;align-items:center;gap:10px}
.puzzle-board{position:relative;border:3px solid #ffd700;border-radius:8px;box-shadow:0 0 30px rgba(255,215,0,.2);background:rgba(0,0,0,.3);overflow:visible}
.puzzle-piece-cv{position:absolute;cursor:pointer;z-index:1;transition:transform .15s}
.puzzle-piece-cv.selected{z-index:5;transform:scale(1.08);filter:drop-shadow(0 0 15px rgba(255,215,0,.9))!important}
.puzzle-piece-cv.correct{cursor:default;z-index:0;transform:none}
.puzzle-piece-cv:not(.correct){filter:drop-shadow(2px 2px 4px rgba(0,0,0,.5))}
.puzzle-ref{border:2px solid #ffd700;border-radius:6px;opacity:.7;object-fit:contain;max-height:70px}
.puzzle-progress{margin-top:8px;font-size:.85rem;color:#ffaaaa;white-space:nowrap}
.puzzle-progress-bar{height:6px;background:#333;border-radius:3px;margin-top:6px;overflow:hidden}
.puzzle-progress-fill{height:100%;background:linear-gradient(90deg,#ff4444,#ffd700);border-radius:3px;transition:width .3s;width:0%}
.btn-shuffle{margin-top:12px;padding:10px 30px;background:linear-gradient(135deg,#cc0000,#aa0000);color:#ffd700;border:2px solid #ffd700;border-radius:30px;font-family:'Noto Serif TC',serif;font-size:1rem;cursor:pointer;white-space:nowrap}
.piece-burst{position:fixed;pointer-events:none;z-index:200}
.swap-anim{transition:left .3s ease,top .3s ease}

/* SCRATCH */
.congrats-text{font-family:'ZCOOL KuaiLe',serif;font-size:clamp(1.5rem,7vw,2.5rem);text-shadow:0 0 30px rgba(255,215,0,.6);text-align:center;margin-bottom:8px;animation:glow 2s ease-in-out infinite alternate;white-space:nowrap}
.congrats-sub{font-size:clamp(.9rem,3vw,1.1rem);color:#ffaaaa;margin-bottom:25px;text-align:center;white-space:nowrap}
.scratch-wrapper{position:relative;width:min(80vw,320px);height:min(50vw,200px);border-radius:16px;overflow:hidden;box-shadow:0 8px 40px rgba(255,0,0,.3);border:3px solid #ffd700}
.scratch-bg{position:absolute;inset:0;background:linear-gradient(135deg,#fff5e6,#fff0d0);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px}
.prize-icon{font-size:50px;margin-bottom:8px}
.prize-text{font-family:'ZCOOL KuaiLe',serif;font-size:clamp(1rem,4vw,1.4rem);color:#cc0000;text-align:center;font-weight:900}
.scratch-canvas{position:absolute;top:0;left:0;width:100%;height:100%;cursor:pointer;touch-action:none}
.scratch-hint{margin-top:20px;font-size:.9rem;color:#ffaaaa;animation:fade 2s ease-in-out infinite;white-space:nowrap}

/* PRIZE */
.prize-reveal{text-align:center;animation:pa .8s ease-out}
@keyframes pa{from{opacity:0;transform:scale(.5) translateY(30px)}to{opacity:1;transform:scale(1) translateY(0)}}
.prize-big-icon{font-size:80px;animation:bounce 1.5s ease-in-out infinite}
.prize-title{font-family:'ZCOOL KuaiLe',serif;font-size:clamp(1.8rem,8vw,3rem);text-shadow:0 0 30px rgba(255,215,0,.6);margin:15px 0 8px;white-space:nowrap}
.prize-desc{font-size:clamp(.9rem,3vw,1.1rem);color:#ffcccc;margin-bottom:25px;white-space:nowrap}
.btn-claim{padding:16px 50px;background:linear-gradient(135deg,#ff1a1a,#cc0000);color:#ffd700;border:3px solid #ffd700;border-radius:40px;font-family:'ZCOOL KuaiLe',serif;font-size:clamp(1.2rem,4vw,1.5rem);cursor:pointer;box-shadow:0 4px 20px rgba(255,0,0,.4);animation:pulse 2s ease-in-out infinite;position:relative;overflow:hidden;white-space:nowrap}
@keyframes pulse{0%,100%{box-shadow:0 4px 20px rgba(255,0,0,.4)}50%{box-shadow:0 4px 30px rgba(255,0,0,.6),0 0 60px rgba(255,215,0,.4)}}
.btn-claim::after{content:'';position:absolute;top:-50%;left:-60%;width:40%;height:200%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.2),transparent);animation:shimmer 2.5s infinite}
@keyframes shimmer{0%{left:-60%}100%{left:120%}}
.manual-code{margin-top:20px;font-size:.8rem;color:#aa8888;text-align:center}
.manual-code span{display:inline-block;background:rgba(255,215,0,.1);padding:4px 12px;border-radius:4px;font-family:monospace;color:#ffd700;margin-top:4px;letter-spacing:1px;user-select:all}
.btn-make-own{margin-top:35px;padding:10px 24px;background:transparent;color:#aa8888;border:1px solid #aa8888;border-radius:20px;font-family:'Noto Serif TC',serif;font-size:.8rem;cursor:pointer}.btn-make-own:hover{color:#ffd700;border-color:#ffd700}

/* EFFECTS */
.coin-container{position:fixed;inset:0;pointer-events:none;z-index:100;overflow:hidden}
.coin{position:absolute;top:-50px;animation:cf linear forwards;pointer-events:none}
@keyframes cf{0%{transform:translateY(0) rotate(0);opacity:1}80%{opacity:1}100%{transform:translateY(110vh) rotate(720deg);opacity:0}}
.firework{position:fixed;pointer-events:none;z-index:99}
.firework-particle{position:absolute;width:4px;height:4px;border-radius:50%;animation:fb 1s ease-out forwards}
@keyframes fb{0%{transform:translate(0,0) scale(1);opacity:1}100%{transform:translate(var(--tx),var(--ty)) scale(0);opacity:0}}
.copied-toast{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0);background:rgba(0,0,0,.93);color:#ffd700;padding:20px 40px;border-radius:16px;font-size:1.1rem;border:2px solid #ffd700;z-index:9999;transition:transform .3s;text-align:center;white-space:nowrap}.copied-toast.show{transform:translate(-50%,-50%) scale(1)}
.loading-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:9999;color:#ffd700;font-size:1.1rem;flex-direction:column;gap:15px}.loading-overlay.show{display:flex}
.loading-spinner{width:40px;height:40px;border:3px solid rgba(255,215,0,.2);border-top-color:#ffd700;border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<div class="bg-pattern"></div>
<div class="lantern">ğŸ®</div><div class="lantern">ğŸ®</div><div class="lantern">ğŸ®</div><div class="lantern">ğŸ®</div>

<!-- CREATOR -->
<div id="creator-screen" class="screen">
  <div class="creator-card">
    <div class="creator-title">ğŸ§§ è·ŸJOYä¸€èµ·éæ–°å¹´ï¼</div>
    <div class="creator-subtitle">ä¸‰æ­¥é©Ÿåšå¥½ï¼Œå‚³é€£çµçµ¦æœ‹å‹å°±èƒ½ç©</div>
    <div class="form-group">
      <label class="form-label">ğŸ“¸ ä¸Šå‚³æ‹¼åœ–ç…§ç‰‡</label>
      <label class="form-file-label" id="file-label"><span class="upload-icon">ğŸ“·</span><span id="file-label-text">é»é€™è£¡é¸æ“‡ç…§ç‰‡</span></label>
      <input type="file" accept="image/*" class="form-file-input" id="photo-input">
      <img class="photo-preview" id="photo-preview">
    </div>
    <div class="form-group"><label class="form-label">ğŸ† çå“é¡å‹</label>
      <select class="form-select" id="prize-type-select">
        <option value="custom" selected>ğŸ¨ è‡ªè¨‚å…Œæ›åˆ¸</option><option value="link">ğŸ”— å•†å“å…Œæ›åˆ¸é€£çµ</option>
      </select>
    </div>
    <!-- è‡ªè¨‚å…Œæ›åˆ¸å€å¡Š -->
    <div id="prize-custom-fields">
      <div class="form-group"><label class="form-label">ğŸ† çå“åç¨±</label><input type="text" class="form-input" id="prize-input" placeholder="ä¾‹ï¼šç•¶å°‘çˆºä¸€å¤©åˆ¸ã€$888ç´…åŒ…"></div>
      <div class="form-group">
        <label class="form-label">ğŸ¨ è‡ªè¨‚å…Œæ›åˆ¸åœ–ç‰‡ <span style="font-size:.75rem;color:#aa8888">ï¼ˆé¸å¡«ï¼Œä¸å‚³æœƒè‡ªå‹•ç”¢ç”Ÿï¼‰</span></label>
        <label class="form-file-label" id="voucher-label" style="padding:15px"><span id="voucher-label-text">ğŸ“ ä¸Šå‚³è‡ªè¨‚å…Œæ›åˆ¸åœ–ç‰‡</span></label>
        <input type="file" accept="image/*" class="form-file-input" id="voucher-input">
      </div>
    </div>
    <!-- å•†å“é€£çµå€å¡Š -->
    <div id="prize-link-fields" style="display:none">
      <div class="form-group"><label class="form-label">ğŸ† çå“åç¨±</label><input type="text" class="form-input" id="prize-link-name" placeholder="ä¾‹ï¼šæ˜Ÿå·´å…‹è²·ä¸€é€ä¸€åˆ¸"></div>
      <div class="form-group"><label class="form-label">ğŸ”— å…Œæ›é€£çµ</label><input type="text" class="form-input" id="prize-link-url" placeholder="https://..."></div>
    </div>
    <div class="form-group"><label class="form-label">ğŸ’¬ ç¥ç¦èª</label><input type="text" class="form-input" id="greeting-input" placeholder="æ–°å¹´å¿«æ¨‚ï¼Œé¦¬å°¼å¤šå¤š" value="æ–°å¹´å¿«æ¨‚ï¼Œé¦¬å°¼å¤šå¤šï¼Œå–œæ‚…ç™¼è²¡"></div>
    <div class="form-group"><label class="form-label">ğŸ§© æ‹¼åœ–é›£åº¦</label>
      <select class="form-select" id="difficulty-select">
        <option value="4" selected>ğŸŸ¢ ç°¡å–®</option><option value="5">ğŸŸ¡ ä¸­ç­‰</option><option value="6">ğŸ”´ å›°é›£</option>
      </select>
    </div>
    <button class="btn-generate" id="btn-generate">ğŸ§§ ç”¢ç”Ÿé€£çµ</button>
    <div class="link-result" id="link-result">
      <div class="link-result-title">âœ… é€£çµç”¢ç”ŸæˆåŠŸï¼å‚³çµ¦å°æ–¹å°±èƒ½ç©</div>
      <div class="link-display" id="link-display"></div>
      <div><button class="btn-copy-link" id="btn-copy-link">ğŸ“‹ è¤‡è£½é€£çµ</button><button class="btn-preview" id="btn-preview">ğŸ‘€ é è¦½</button></div>
      <div class="link-warning"></div>
    </div>
  </div>
</div>

<!-- INTRO -->
<div id="intro-screen" class="screen">
  <div class="intro-title">ğŸ§§ æ–°å¹´å¿«æ¨‚ ğŸ§§</div>
  <div class="intro-subtitle" id="greeting-text"></div>
  <div class="intro-envelope" id="start-btn" role="button">ğŸ§§</div>
  <div class="intro-hint">ğŸ‘† é»æ“Šç´…åŒ…é–‹å§‹</div>
</div>

<!-- PUZZLE -->
<div id="puzzle-screen" class="screen">
  <div class="puzzle-header">ğŸ§© æ‹¼å‡ºæ–°å¹´å¥½é‹</div>
  <div class="puzzle-wrapper">
    <div style="display:flex;align-items:flex-start;gap:10px">
      <div class="puzzle-board" id="puzzle-board"></div>
      <img class="puzzle-ref" id="puzzle-ref" alt="åƒè€ƒåœ–">
    </div>
  </div>
  <div class="puzzle-hint" style="margin-top:6px;font-size:.8rem;color:#cc8888;text-align:center;white-space:nowrap">ğŸ‘† é»ä¸€ç‰‡é¸ä¸­ï¼Œå†é»å¦ä¸€ç‰‡äº¤æ›ä½ç½®</div>
  <div class="puzzle-progress">å·²å®Œæˆ <span id="progress-count">0</span> / <span id="progress-total">16</span> ç‰‡</div>
  <div class="puzzle-progress-bar" id="progress-bar"><div class="puzzle-progress-fill" id="progress-fill"></div></div>
  <button class="btn-shuffle" id="btn-shuffle">ğŸ”€ é‡æ–°æ‰“äº‚</button>
</div>

<!-- SCRATCH + PRIZE (same screen) -->
<div id="scratch-screen" class="screen">
  <div class="congrats-text">ğŸ‰ æ­å–œå®Œæˆï¼</div>
  <div class="congrats-sub">æ–°å¹´å¿«æ¨‚ï¼Œç¥æ‚¨ä¸­å¤§çï¼</div>
  <div class="scratch-wrapper" id="scratch-wrapper">
    <div class="scratch-bg">
      <div class="prize-icon">ğŸŠ</div>
      <div class="prize-text" id="prize-label">ğŸ† ç•¶å°‘çˆºä¸€å¤©åˆ¸</div>
    </div>
    <canvas class="scratch-canvas" id="scratch-canvas"></canvas>
  </div>
  <div class="scratch-hint" id="scratch-hint">ğŸ‘† ç”¨æ‰‹æŒ‡åˆ®é–‹çœ‹çœ‹</div>
  <!-- Prize area (hidden until scratched) -->
  <div id="prize-area" style="display:none;text-align:center;margin-top:15px;animation:prizeAppear .6s ease-out">
    <canvas id="voucher-canvas" style="border-radius:16px;box-shadow:0 4px 30px rgba(255,0,0,.4);max-width:85vw"></canvas>
    <img id="voucher-custom-img" style="display:none;border-radius:16px;box-shadow:0 4px 30px rgba(255,0,0,.4);max-width:85vw;max-height:40vh">
    <div id="voucher-link-btn-wrap" style="display:none;margin-top:15px"><a id="voucher-link-btn" href="#" target="_blank" style="display:inline-block;padding:14px 40px;background:linear-gradient(135deg,#ff1a1a,#cc0000);color:#ffd700;border:2px solid #ffd700;border-radius:30px;font-family:'ZCOOL KuaiLe',serif;font-size:1.1rem;text-decoration:none;box-shadow:0 4px 20px rgba(255,0,0,.4);animation:pulse 2s ease-in-out infinite">ğŸ ç«‹å³å…Œæ›</a></div>
    <div style="margin-top:12px;font-size:.85rem;color:#ffaaaa">ğŸ“± é•·æŒ‰åœ–ç‰‡å³å¯ä¿å­˜å…Œæ›åˆ¸ï¼</div>
    <button class="btn-make-own" id="btn-make-own" style="margin-top:20px">âœ¨ æˆ‘ä¹Ÿè¦åšä¸€å€‹é€æœ‹å‹</button>
  </div>
</div>

<div class="copied-toast" id="copied-toast"></div>
<div class="coin-container" id="coin-container"></div>
<div class="loading-overlay" id="loading-overlay"><div class="loading-spinner"></div><div>æ­£åœ¨ä¸Šå‚³ç…§ç‰‡...</div></div>

<script>
// ===== CONFIG =====
const IMGBB_API_KEY='f3b38ce5bec9cb00a5ee4c5bf768ad2a';
// Prize name is stored in CONFIG.prizeName
let CONFIG={puzzleImage:'',prizeName:'',greeting:'æ–°å¹´å¿«æ¨‚ï¼Œé¦¬å°¼å¤šå¤šï¼Œå–œæ‚…ç™¼è²¡',puzzleSize:4,scratchThreshold:0.45,voucherImg:'',prizeLink:''};

// ===== AUDIO =====
let audioCtx=null;
function ac(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();return audioCtx;}
function playCoinSound(){try{const c=ac(),o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(c.destination);o.type='triangle';o.frequency.setValueAtTime(1200,c.currentTime);o.frequency.exponentialRampToValueAtTime(2400,c.currentTime+.1);g.gain.setValueAtTime(.3,c.currentTime);g.gain.exponentialRampToValueAtTime(.01,c.currentTime+.3);o.start();o.stop(c.currentTime+.3);}catch(e){}}
function playWinSound(){try{const c=ac();[523,659,784,1047].forEach((f,i)=>{const o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(c.destination);o.type='triangle';o.frequency.value=f;g.gain.setValueAtTime(.25,c.currentTime+i*.15);g.gain.exponentialRampToValueAtTime(.01,c.currentTime+i*.15+.5);o.start(c.currentTime+i*.15);o.stop(c.currentTime+i*.15+.5);});}catch(e){}}
function playJackpotSound(){try{const c=ac();[523,587,659,784,880,1047,1175,1319].forEach((f,i)=>{const o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(c.destination);o.type='square';o.frequency.value=f;g.gain.setValueAtTime(.15,c.currentTime+i*.1);g.gain.exponentialRampToValueAtTime(.01,c.currentTime+i*.1+.4);o.start(c.currentTime+i*.1);o.stop(c.currentTime+i*.1+.4);});[1047,1319,1568].forEach(f=>{const o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(c.destination);o.type='triangle';o.frequency.value=f;const t=c.currentTime+.85;g.gain.setValueAtTime(.2,t);g.gain.exponentialRampToValueAtTime(.01,t+1.5);o.start(t);o.stop(t+1.5);});}catch(e){}}
function playScratchSound(){try{const c=ac(),b=c.createBuffer(1,c.sampleRate*.05,c.sampleRate),d=b.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=Math.random()*2-1;const s=c.createBufferSource();s.buffer=b;const g=c.createGain();g.gain.value=.05;const fl=c.createBiquadFilter();fl.type='bandpass';fl.frequency.value=3000;s.connect(fl);fl.connect(g);g.connect(c.destination);s.start();}catch(e){}}

// ===== EFFECTS =====
function spawnCoins(n=30,dur=3000){const co=document.getElementById('coin-container'),em=['ğŸª™','ğŸ’°','ğŸ§§','âœ¨','ğŸŠ','ğŸ’µ'];for(let i=0;i<n;i++){setTimeout(()=>{const c=document.createElement('div');c.className='coin';c.textContent=em[Math.floor(Math.random()*em.length)];c.style.left=Math.random()*100+'vw';c.style.fontSize=(20+Math.random()*25)+'px';const d=2+Math.random()*2;c.style.animationDuration=d+'s';co.appendChild(c);setTimeout(()=>c.remove(),d*1000);},Math.random()*dur);}}
function spawnCoinBurst(x,y){
  const em=['ğŸª™','ğŸ’°','ğŸ§§','âœ¨'];
  for(let i=0;i<8;i++){
    const el=document.createElement('div');el.className='piece-burst';
    el.textContent=em[Math.floor(Math.random()*em.length)];
    el.style.left=x+'px';el.style.top=y+'px';
    el.style.fontSize=(16+Math.random()*12)+'px';
    const angle=Math.random()*Math.PI*2;
    const dist=40+Math.random()*60;
    const tx=Math.cos(angle)*dist,ty=Math.sin(angle)*dist-40;
    el.style.transition='all .7s ease-out';
    el.style.opacity='1';
    document.body.appendChild(el);
    requestAnimationFrame(()=>{requestAnimationFrame(()=>{el.style.transform=`translate(${tx}px,${ty}px)`;el.style.opacity='0';});});
    setTimeout(()=>el.remove(),800);
  }
  playCoinSound();
}
function spawnFirework(x,y){const cl=['#ffd700','#ff4444','#ff8800','#ffaaaa','#fff'],el=document.createElement('div');el.className='firework';el.style.left=x+'px';el.style.top=y+'px';document.body.appendChild(el);for(let i=0;i<20;i++){const p=document.createElement('div');p.className='firework-particle';const a=Math.PI*2*i/20,d=50+Math.random()*80;p.style.setProperty('--tx',Math.cos(a)*d+'px');p.style.setProperty('--ty',Math.sin(a)*d+'px');p.style.background=cl[Math.floor(Math.random()*cl.length)];el.appendChild(p);}setTimeout(()=>el.remove(),1200);}
function fireMultipleFireworks(){for(let i=0;i<6;i++)setTimeout(()=>spawnFirework(Math.random()*innerWidth,Math.random()*innerHeight*.6),i*350);}

// ===== UTILS =====
function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');}
function showToast(msg){const t=document.getElementById('copied-toast');t.innerHTML=msg.replace(/\n/g,'<br>');t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500);}

// ===== IMGBB =====
function compressImage(file,maxW=600,q=0.7){return new Promise(r=>{const rd=new FileReader();rd.onload=e=>{const img=new Image();img.onload=()=>{const cv=document.createElement('canvas');let w=img.width,h=img.height;if(Math.max(w,h)>maxW){if(w>h){h=maxW/w*h;w=maxW;}else{w=maxW/h*w;h=maxW;}}cv.width=w;cv.height=h;cv.getContext('2d').drawImage(img,0,0,w,h);cv.toBlob(blob=>r(blob),'image/jpeg',q);};img.src=e.target.result;};rd.readAsDataURL(file);});}

async function uploadToImgBB(blob){
  return new Promise((resolve,reject)=>{
    const reader=new FileReader();
    reader.onload=async function(){
      try{
        const base64=reader.result.split(',')[1];
        const fd=new FormData();fd.append('image',base64);
        const res=await fetch('https://api.imgbb.com/1/upload?key='+IMGBB_API_KEY+'&expiration=604800',{method:'POST',body:fd});
        if(!res.ok){reject(new Error('HTTP '+res.status));return;}
        const data=await res.json();
        if(!data.success){reject(new Error(JSON.stringify(data.error||data)));return;}
        resolve(data.data.display_url);
      }catch(e){reject(new Error('ç¶²è·¯éŒ¯èª¤: '+e.message));}
    };reader.onerror=()=>reject(new Error('è®€å–å¤±æ•—'));reader.readAsDataURL(blob);
  });
}

function buildUrl(imageUrl,prize,greeting,size,voucherImg,prizeLink){const p=new URLSearchParams();p.set('p',imageUrl);p.set('r',prize);p.set('g',greeting);p.set('s',size);if(voucherImg)p.set('v',voucherImg);if(prizeLink)p.set('l',prizeLink);return location.origin+location.pathname+'?'+p.toString();}
function readUrlParams(){const p=new URLSearchParams(location.search);if(!p.get('p'))return null;return{puzzleImage:p.get('p'),prizeName:p.get('r')||'ç¥ç§˜å¤§ç',greeting:p.get('g')||'æ–°å¹´å¿«æ¨‚ï¼Œé¦¬å°¼å¤šå¤šï¼Œå–œæ‚…ç™¼è²¡',puzzleSize:parseInt(p.get('s'))||4,voucherImg:p.get('v')||'',prizeLink:p.get('l')||''};}

// ===== CREATOR =====
let selectedFile=null,selectedVoucherFile=null;

// Prize type toggle
document.getElementById('prize-type-select').addEventListener('change',e=>{
  const isLink=e.target.value==='link';
  document.getElementById('prize-custom-fields').style.display=isLink?'none':'block';
  document.getElementById('prize-link-fields').style.display=isLink?'block':'none';
});

document.getElementById('file-label').addEventListener('click',()=>document.getElementById('photo-input').click());
document.getElementById('photo-input').addEventListener('change',async e=>{const f=e.target.files[0];if(!f)return;selectedFile=f;document.getElementById('file-label').classList.add('has-file');document.getElementById('file-label-text').textContent='âœ… '+f.name;const rd=new FileReader();rd.onload=ev=>{const p=document.getElementById('photo-preview');p.src=ev.target.result;p.style.display='block';};rd.readAsDataURL(f);});

document.getElementById('voucher-label').addEventListener('click',()=>document.getElementById('voucher-input').click());
document.getElementById('voucher-input').addEventListener('change',e=>{const f=e.target.files[0];if(!f)return;selectedVoucherFile=f;document.getElementById('voucher-label').classList.add('has-file');document.getElementById('voucher-label-text').textContent='âœ… '+f.name;});

document.getElementById('btn-generate').addEventListener('click',async()=>{
  if(!selectedFile){showToast('âš ï¸ è«‹å…ˆä¸Šå‚³ç…§ç‰‡');return;}
  const prizeType=document.getElementById('prize-type-select').value;
  let prize='',prizeLink='';
  if(prizeType==='link'){
    prize=document.getElementById('prize-link-name').value.trim();
    if(!prize){showToast('âš ï¸ è«‹è¼¸å…¥çå“åç¨±');return;}
    prizeLink=document.getElementById('prize-link-url').value.trim();
    if(!prizeLink){showToast('âš ï¸ è«‹è¼¸å…¥å…Œæ›é€£çµ');return;}
    if(!prizeLink.startsWith('http'))prizeLink='https://'+prizeLink;
  } else {
    prize=document.getElementById('prize-input').value.trim();
    if(!prize){showToast('âš ï¸ è«‹è¼¸å…¥çå“åç¨±');return;}
  }
  const greeting=document.getElementById('greeting-input').value.trim()||'æ–°å¹´å¿«æ¨‚ï¼Œé¦¬å°¼å¤šå¤šï¼Œå–œæ‚…ç™¼è²¡';
  const size=parseInt(document.getElementById('difficulty-select').value);
  document.getElementById('loading-overlay').classList.add('show');
  try{
    const blob=await compressImage(selectedFile);
    const imageUrl=await uploadToImgBB(blob);
    let voucherUrl='';
    if(prizeType==='custom'&&selectedVoucherFile){
      const vBlob=await compressImage(selectedVoucherFile);
      voucherUrl=await uploadToImgBB(vBlob);
    }
    const url=buildUrl(imageUrl,prize,greeting,size,voucherUrl,prizeLink);
    document.getElementById('link-display').textContent=url;
    document.getElementById('link-result').style.display='block';
    document.querySelector('.link-warning').textContent='ğŸ“¸ ç…§ç‰‡æœƒåœ¨ 7 å¤©å¾Œè‡ªå‹•åˆªé™¤ï¼Œè«‹ç¢ºä¿å°æ–¹åœ¨æœŸé™å…§æ‰“é–‹';
    document.querySelector('.link-warning').style.color='#ffcc88';
  }catch(err){showToast('âŒ '+err.message);console.error(err);}
  document.getElementById('loading-overlay').classList.remove('show');
});

document.getElementById('btn-copy-link').addEventListener('click',async()=>{const u=document.getElementById('link-display').textContent;try{await navigator.clipboard.writeText(u);}catch{const t=document.createElement('textarea');t.value=u;document.body.appendChild(t);t.select();document.execCommand('copy');document.body.removeChild(t);}showToast('âœ… é€£çµå·²è¤‡è£½');});
document.getElementById('btn-preview').addEventListener('click',()=>window.open(document.getElementById('link-display').textContent,'_blank'));

// ===== INIT =====
function init(){const d=readUrlParams();if(d){CONFIG={...CONFIG,...d};setupPlayer();return;}showScreen('creator-screen');}
function setupPlayer(){
  document.getElementById('greeting-text').textContent=CONFIG.greeting;
  // Set prize label in scratch card
  document.getElementById('prize-label').textContent='ğŸ† '+CONFIG.prizeName;
  // Setup voucher
  if(CONFIG.voucherImg){
    document.getElementById('voucher-canvas').style.display='none';
    const img=document.getElementById('voucher-custom-img');
    img.src=CONFIG.voucherImg;img.style.display='block';
  } else {
    document.getElementById('voucher-custom-img').style.display='none';
    drawVoucher(CONFIG.prizeName,CONFIG.greeting,CONFIG.prizeLink);
  }
  // Setup prize link button
  if(CONFIG.prizeLink){
    const wrap=document.getElementById('voucher-link-btn-wrap');
    const btn=document.getElementById('voucher-link-btn');
    btn.href=CONFIG.prizeLink;
    wrap.style.display='block';
  }
  showScreen('intro-screen');
}

function drawVoucher(prizeName,greeting,prizeLink){
  const cv=document.getElementById('voucher-canvas');
  const w=640,h=prizeLink?380:320;
  cv.width=w;cv.height=h;
  cv.style.width=Math.min(window.innerWidth*.85,360)+'px';
  const ctx=cv.getContext('2d');
  const bg=ctx.createLinearGradient(0,0,w,h);
  bg.addColorStop(0,'#cc0000');bg.addColorStop(.5,'#ee1111');bg.addColorStop(1,'#aa0000');
  ctx.fillStyle=bg;
  roundRect(ctx,0,0,w,h,24);ctx.fill();
  ctx.strokeStyle='#ffd700';ctx.lineWidth=4;
  roundRect(ctx,12,12,w-24,h-24,16);ctx.stroke();
  ctx.strokeStyle='rgba(255,215,0,0.3)';ctx.lineWidth=1;
  roundRect(ctx,20,20,w-40,h-40,12);ctx.stroke();
  // Title
  ctx.fillStyle='#ffd700';ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.font='bold 26px "Noto Serif TC",serif';
  ctx.fillText('ğŸ§§ æ–°å¹´å…Œæ›åˆ¸ ğŸ§§',w/2,50);
  // Prize name - big
  ctx.font='bold 56px "ZCOOL KuaiLe","Noto Serif TC",serif';
  ctx.shadowColor='rgba(255,215,0,0.4)';ctx.shadowBlur=20;
  ctx.fillText(prizeName,w/2,prizeLink?h/2-25:h/2);
  ctx.shadowBlur=0;
  // Prize link hint
  if(prizeLink){
    ctx.font='bold 18px "Noto Serif TC",serif';
    ctx.fillStyle='rgba(255,215,0,0.7)';
    ctx.fillText('ğŸ‘‡ é»æ“Šä¸‹æ–¹æŒ‰éˆ•å‰å¾€å…Œæ›',w/2,h/2+20);
  }
  // Bottom
  ctx.fillStyle='rgba(255,215,0,0.5)';
  ctx.font='18px "Noto Serif TC",serif';
  ctx.fillText('ğŸ“± é•·æŒ‰ä¿å­˜ãƒ»æ‰¾é€ç¦®äººå…Œæ›',w/2,h-60);
  const d=new Date();
  ctx.font='bold 22px "Noto Serif TC",serif';
  ctx.fillStyle='rgba(255,215,0,0.6)';
  ctx.fillText('â° '+(d.getMonth()+1)+'/'+d.getDate()+' èµ· 7 å¤©å…§æœ‰æ•ˆ',w/2,h-30);
}

function roundRect(ctx,x,y,w,h,r){ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);ctx.lineTo(x+r,y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-r);ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);ctx.closePath();}

// ===== INTRO =====
document.getElementById('start-btn').addEventListener('click',()=>{playCoinSound();showScreen('puzzle-screen');loadAndInitPuzzle();});

// ===== PUZZLE ENGINE (auto-ratio, no overlap, jigsaw edges) =====
let puzzlePieces=[],correctCount=0,totalPieces=0;
let puzzleImg=null,cols=0,rows=0,cellW=0,cellH=0,boardW=0,boardH=0,tabSize=0,pieceExtra=0;
let edgesH=[],edgesV=[];
let puzzleGrid=[],piecePositions=[];

function loadAndInitPuzzle(){
  puzzleImg=new Image();
  puzzleImg.crossOrigin='anonymous';
  puzzleImg.onload=()=>{
    const sz=CONFIG.puzzleSize;
    const ratio=puzzleImg.width/puzzleImg.height;
    // Determine cols x rows based on ratio
    if(ratio>1.4){cols=sz+1;rows=sz-1;}      // wide (16:9 etc)
    else if(ratio>1.1){cols=sz;rows=sz-1;}    // 4:3
    else if(ratio<0.7){cols=sz-1;rows=sz+1;}  // tall portrait
    else if(ratio<0.9){cols=sz-1;rows=sz;}    // portrait 3:4
    else{cols=sz;rows=sz;}                     // square-ish
    if(cols<2)cols=2;if(rows<2)rows=2;
    totalPieces=cols*rows;

    // Board dimensions to fit screen - BIGGER
    const maxW=Math.min(window.innerWidth*.92,440);
    const maxH=Math.min(window.innerHeight*.58,440);
    const imgRatio=puzzleImg.width/puzzleImg.height;
    if(maxW/maxH > imgRatio){boardH=maxH;boardW=boardH*imgRatio;}
    else{boardW=maxW;boardH=boardW/imgRatio;}
    boardW=Math.floor(boardW);boardH=Math.floor(boardH);

    cellW=boardW/cols;cellH=boardH/rows;
    tabSize=Math.min(cellW,cellH)*0.12;
    pieceExtra=Math.ceil(Math.max(cellW,cellH)*0.3);

    // Generate edge map (random tabs/blanks)
    // Each internal edge is shared by two adjacent pieces.
    // We store +1 or -1 randomly. When drawing:
    //   - Top edge of piece(r,c) uses edgesH[r][c] as-is
    //   - Bottom edge uses -edgesH[r+1][c] (flipped, so they interlock)
    //   - Left edge of piece(r,c) uses edgesV[r][c] as-is
    //   - Right edge uses -edgesV[r][c+1] (flipped, so they interlock)
    edgesH=[];edgesV=[];
    for(let r=0;r<=rows;r++){edgesH[r]=[];for(let c=0;c<cols;c++)edgesH[r][c]=(r===0||r===rows)?0:(Math.random()>.5?1:-1);}
    for(let r=0;r<rows;r++){edgesV[r]=[];for(let c=0;c<=cols;c++)edgesV[r][c]=(c===0||c===cols)?0:(Math.random()>.5?1:-1);}

    // Setup board
    const board=document.getElementById('puzzle-board');
    board.style.width=boardW+'px';board.style.height=boardH+'px';
    board.innerHTML='';

    // Ref image
    const ref=document.getElementById('puzzle-ref');
    ref.src=CONFIG.puzzleImage;
    ref.style.width=Math.min(boardW*.25,90)+'px';

    // Progress bar
    document.getElementById('progress-bar').style.width=boardW+'px';
    document.getElementById('progress-total').textContent=totalPieces;

    puzzlePieces=[];correctCount=0;updateProgress();

    puzzleGrid=[];piecePositions=[];
    const piecesArr=[];
    let idx=0;
    for(let r=0;r<rows;r++){
      puzzleGrid[r]=[];
      for(let c=0;c<cols;c++){
        const cv=document.createElement('canvas');
        cv.width=Math.ceil(cellW+pieceExtra*2);cv.height=Math.ceil(cellH+pieceExtra*2);
        cv.className='puzzle-piece-cv';
        cv.dataset.col=c;cv.dataset.row=r;
        cv.dataset.idx=idx;
        drawPiece(cv,r,c,pieceExtra,'wrong');
        cv.classList.add('wrong');
        piecesArr.push(cv);
        puzzleGrid[r][c]=idx;
        piecePositions[idx]={r,c};
        idx++;
      }
    }
    puzzlePieces=piecesArr;

    // Place all pieces at their current grid positions
    piecesArr.forEach(cv=>{board.appendChild(cv);});
    positionAllPieces();

    // Shuffle
    shufflePieces();
    setupSwap();
  };
  puzzleImg.onerror=()=>{showToast('âš ï¸ ç…§ç‰‡è¼‰å…¥å¤±æ•—');};
  puzzleImg.src=CONFIG.puzzleImage;
}

function positionAllPieces(){
  puzzlePieces.forEach((cv,i)=>{
    const pos=piecePositions[i];
    cv.style.left=(pos.c*cellW-pieceExtra)+'px';
    cv.style.top=(pos.r*cellH-pieceExtra)+'px';
  });
}

function drawPiece(canvas,row,col,extra,highlight){
  const ctx=canvas.getContext('2d');
  const w=cellW,h=cellH;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.save();
  ctx.translate(extra,extra);

  // Build jigsaw clip path
  ctx.beginPath();
  ctx.moveTo(0,0);
  tabEdge(ctx, 0,0, w,0, edgesH[row][col]);       // top edge
  tabEdge(ctx, w,0, w,h, -edgesV[row][col+1]);    // right edge (flipped for interlocking)
  tabEdge(ctx, w,h, 0,h, -edgesH[row+1][col]);    // bottom edge (flipped for interlocking)
  tabEdge(ctx, 0,h, 0,0, edgesV[row][col]);       // left edge
  ctx.closePath();
  
  // Save path for border
  ctx.save();
  ctx.clip();

  // Draw image
  ctx.drawImage(puzzleImg,
    0, 0, puzzleImg.width, puzzleImg.height,
    -col*cellW, -row*cellH,
    boardW, boardH
  );
  ctx.restore();

  // Draw border along jigsaw edge
  if(highlight==='wrong'){
    ctx.strokeStyle='rgba(255,50,50,0.85)';
    ctx.lineWidth=3.5;
    ctx.stroke();
    // Second glow pass
    ctx.strokeStyle='rgba(255,150,0,0.4)';
    ctx.lineWidth=6;
    ctx.stroke();
  } else if(highlight==='correct'){
    ctx.strokeStyle='rgba(80,255,80,0.6)';
    ctx.lineWidth=2;
    ctx.stroke();
  } else {
    ctx.strokeStyle='rgba(0,0,0,0.3)';
    ctx.lineWidth=1.5;
    ctx.stroke();
  }
  ctx.restore();
}

function redrawPiece(cv, highlight){
  const r=parseInt(cv.dataset.row), c=parseInt(cv.dataset.col);
  drawPiece(cv,r,c,pieceExtra,highlight);
}

// Simple reliable tab: straight line with a semicircular bump
function tabEdge(ctx, x1,y1, x2,y2, type){
  if(type===0){ctx.lineTo(x2,y2);return;}
  const dx=x2-x1, dy=y2-y1;
  const len=Math.sqrt(dx*dx+dy*dy);
  // unit vectors
  const ex=dx/len, ey=dy/len; // along edge
  const nx=-ey, ny=ex;         // perpendicular (outward = left of travel for CW)
  const r=len*0.12;            // tab radius (proportional to edge length)
  const mid=len*0.5;
  const sign=type; // +1 or -1

  // Point before tab
  const bx=x1+ex*(mid-r), by=y1+ey*(mid-r);
  ctx.lineTo(bx,by);

  // Semicircle center
  const cx=x1+ex*mid+nx*r*sign;
  const cy=y1+ey*mid+ny*r*sign;

  // Arc angles
  const startAngle=Math.atan2(by-cy, bx-cx);
  const endX=x1+ex*(mid+r), endY=y1+ey*(mid+r);
  const endAngle=Math.atan2(endY-cy, endX-cx);

  // Draw arc (counterclockwise for outward tab, clockwise for inward)
  ctx.arc(cx,cy,r, startAngle, endAngle, sign>0);

  // Continue to end
  ctx.lineTo(x2,y2);
}

function shufflePieces(){
  correctCount=0;
  const allPos=[];
  for(let r=0;r<rows;r++)for(let c=0;c<cols;c++)allPos.push({r,c});
  // Fisher-Yates shuffle
  for(let i=allPos.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[allPos[i],allPos[j]]=[allPos[j],allPos[i]];}
  // Ensure no piece starts in correct position
  for(let i=0;i<allPos.length;i++){
    const origR=Math.floor(i/cols), origC=i%cols;
    if(allPos[i].r===origR && allPos[i].c===origC){
      const j=(i+1)%allPos.length;
      [allPos[i],allPos[j]]=[allPos[j],allPos[i]];
    }
  }
  for(let i=0;i<puzzlePieces.length;i++){
    piecePositions[i]=allPos[i];
    puzzleGrid[allPos[i].r][allPos[i].c]=i;
  }
  positionAllPieces();
  // Reset all pieces to wrong state
  puzzlePieces.forEach(p=>{
    p.classList.remove('correct','selected','swap-anim');
    p.classList.add('wrong');
    redrawPiece(p,'wrong');
  });
  selectedPiece=null;
  isSwapping=false;
  updateProgress();
}

let selectedPiece=null;
let swapSetup=false;
let isSwapping=false;

function setupSwap(){
  if(swapSetup)return; // prevent duplicate listeners
  swapSetup=true;
  const board=document.getElementById('puzzle-board');

  board.addEventListener('click',function(e){
    if(isSwapping)return;
    const cv=e.target.closest('.puzzle-piece-cv');
    if(!cv||cv.classList.contains('correct'))return;

    if(!selectedPiece){
      selectedPiece=cv;
      cv.classList.add('selected');
    } else if(selectedPiece===cv){
      cv.classList.remove('selected');
      selectedPiece=null;
    } else {
      isSwapping=true;
      const idx1=parseInt(selectedPiece.dataset.idx);
      const idx2=parseInt(cv.dataset.idx);
      const pos1={...piecePositions[idx1]};
      const pos2={...piecePositions[idx2]};

      selectedPiece.classList.add('swap-anim');
      cv.classList.add('swap-anim');

      piecePositions[idx1]=pos2;
      piecePositions[idx2]=pos1;
      puzzleGrid[pos1.r][pos1.c]=idx2;
      puzzleGrid[pos2.r][pos2.c]=idx1;

      positionAllPieces();
      selectedPiece.classList.remove('selected');
      selectedPiece=null;

      setTimeout(()=>{
        puzzlePieces.forEach(p=>p.classList.remove('swap-anim'));
        checkAllCorrect();
        isSwapping=false;
      },320);
    }
  });
}

function checkAllCorrect(){
  correctCount=0;
  puzzlePieces.forEach((cv,i)=>{
    const origR=parseInt(cv.dataset.row);
    const origC=parseInt(cv.dataset.col);
    const curPos=piecePositions[i];
    if(curPos.r===origR && curPos.c===origC){
      if(!cv.classList.contains('correct')){
        cv.classList.add('correct');
        cv.classList.remove('wrong');
        redrawPiece(cv,'correct');
        const rect=cv.getBoundingClientRect();
        spawnCoinBurst(rect.left+rect.width/2,rect.top+rect.height/2);
      }
      correctCount++;
    } else {
      if(cv.classList.contains('correct')){
        cv.classList.remove('correct');
        cv.classList.add('wrong');
        redrawPiece(cv,'wrong');
      }
    }
  });
  updateProgress();
  if(correctCount>=totalPieces)onPuzzleComplete();
}

function updateProgress(){document.getElementById('progress-count').textContent=correctCount;document.getElementById('progress-fill').style.width=(totalPieces?correctCount/totalPieces*100:0)+'%';}
function onPuzzleComplete(){playWinSound();spawnCoins(15,1500);setTimeout(()=>{showScreen('scratch-screen');initScratchCard();},1500);}
document.getElementById('btn-shuffle').addEventListener('click',shufflePieces);

// ===== SCRATCH =====
let scratchRevealed=false;
function initScratchCard(){scratchRevealed=false;const w=document.getElementById('scratch-wrapper'),cv=document.getElementById('scratch-canvas'),ctx=cv.getContext('2d');cv.width=w.offsetWidth;cv.height=w.offsetHeight;cv.style.opacity='1';cv.style.transition='';
const gr=ctx.createLinearGradient(0,0,cv.width,cv.height);gr.addColorStop(0,'#cc0000');gr.addColorStop(.5,'#ee2222');gr.addColorStop(1,'#cc0000');ctx.fillStyle=gr;ctx.fillRect(0,0,cv.width,cv.height);
ctx.strokeStyle='#ffd700';ctx.lineWidth=3;ctx.strokeRect(10,10,cv.width-20,cv.height-20);ctx.strokeRect(15,15,cv.width-30,cv.height-30);
ctx.fillStyle='#ffd700';ctx.font=`bold ${Math.min(cv.width*.08,28)}px "Noto Serif TC",serif`;ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('ğŸ° åˆ®åˆ®æ¨‚ ğŸ°',cv.width/2,cv.height/2-15);
ctx.font=`${Math.min(cv.width*.05,18)}px "Noto Serif TC",serif`;ctx.fillText('ç”¨æ‰‹æŒ‡åˆ®é–‹æ­¤å€',cv.width/2,cv.height/2+20);
let isS=false,ls=0;
function scratch(x,y){ctx.globalCompositeOperation='destination-out';ctx.beginPath();ctx.arc(x,y,25,0,Math.PI*2);ctx.fill();if(Date.now()-ls>80){playScratchSound();ls=Date.now();}checkScratch();}
function gp(e){const r=cv.getBoundingClientRect(),cx=e.touches?e.touches[0].clientX:e.clientX,cy=e.touches?e.touches[0].clientY:e.clientY;return{x:(cx-r.left)*(cv.width/r.width),y:(cy-r.top)*(cv.height/r.height)};}
cv.onmousedown=e=>{isS=true;scratch(gp(e).x,gp(e).y);};cv.onmousemove=e=>{if(isS){const p=gp(e);scratch(p.x,p.y);}};cv.onmouseup=()=>isS=false;cv.onmouseleave=()=>isS=false;
cv.addEventListener('touchstart',e=>{isS=true;scratch(gp(e).x,gp(e).y);e.preventDefault();},{passive:false});
cv.addEventListener('touchmove',e=>{if(isS){const p=gp(e);scratch(p.x,p.y);}e.preventDefault();},{passive:false});
cv.addEventListener('touchend',()=>isS=false);}

function checkScratch(){if(scratchRevealed)return;const cv=document.getElementById('scratch-canvas'),d=cv.getContext('2d').getImageData(0,0,cv.width,cv.height).data;let t=0;for(let i=3;i<d.length;i+=4)if(d[i]===0)t++;if(t/(d.length/4)>=CONFIG.scratchThreshold){scratchRevealed=true;cv.style.transition='opacity .5s';cv.style.opacity='0';document.getElementById('scratch-hint').style.display='none';setTimeout(()=>{playJackpotSound();spawnCoins(20,2000);fireMultipleFireworks();if(navigator.vibrate)navigator.vibrate([100,50,100,50,200]);document.getElementById('prize-area').style.display='block';
// Convert voucher canvas to img for long-press save
setTimeout(()=>{
  const vc=document.getElementById('voucher-canvas');
  if(vc&&vc.style.display!=='none'){
    try{
      const dataUrl=vc.toDataURL('image/png');
      const saveImg=document.createElement('img');
      saveImg.src=dataUrl;
      saveImg.style.cssText='border-radius:16px;box-shadow:0 4px 30px rgba(255,0,0,.4);max-width:85vw;display:block;margin:0 auto;';
      saveImg.alt='å…Œæ›åˆ¸ - é•·æŒ‰ä¿å­˜';
      vc.parentNode.insertBefore(saveImg,vc);
      vc.style.display='none';
    }catch(e){}
  }
},300);
},1500);}}

// ===== PRIZE =====
document.getElementById('btn-make-own').addEventListener('click',()=>{window.location.href=location.origin+location.pathname;});

init();
</script>
</body>
</html>
